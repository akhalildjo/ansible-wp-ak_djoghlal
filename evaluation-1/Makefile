SSH_KEY=~/.ssh/ansible_key
SSH_PUB=$(SSH_KEY).pub

all: up ssh-key inject-key

# Ã‰tape 1 : Lancer docker-compose
up:
	docker-compose up -d

# Ã‰tape 2 : GÃ©nÃ©rer la paire de clÃ©s si elle n'existe pas
ssh-key:
	@if [ ! -f $(SSH_KEY) ]; then \
		echo "[+] GÃ©nÃ©ration de la paire de clÃ©s SSH..."; \
		ssh-keygen -t rsa -b 4096 -f $(SSH_KEY) -N ""; \
	else \
		echo "[âœ”] ClÃ© SSH dÃ©jÃ  existante Ã  $(SSH_KEY)"; \
	fi

# Ã‰tape 3 : Injecter la clÃ© publique dans les conteneurs
inject-key:
	@for container in ubuntu-ansible rocky-ansible; do \
		echo "[+] Attente que l'utilisateur 'ansible' soit prÃªt dans $$container..."; \
		until docker exec $$container id ansible >/dev/null 2>&1; do \
			sleep 1; \
		done; \
		echo "[âœ”] Utilisateur 'ansible' prÃªt dans $$container"; \
		echo "[+] Injection de la clÃ© SSH dans $$container..."; \
		docker exec -u ansible $$container mkdir -p /home/ansible/.ssh; \
		docker cp $(SSH_PUB) $$container:/home/ansible/.ssh/authorized_keys; \
		docker exec -u root $$container chown -R ansible:ansible /home/ansible/.ssh; \
		docker exec -u root $$container chmod 700 /home/ansible/.ssh; \
		docker exec -u root $$container chmod 600 /home/ansible/.ssh/authorized_keys; \
	done

ping:
	@echo "[+] Test de la connexion SSH avec Ansible..."
	ansible -i inventory.yml all -m ping

deploy:
	@mkdir -p logs
	@echo "[+] DÃ©ploiement WordPress avec Ansible..."
	@ansible-playbook -i inventory.yml site_local_role.yml -vv > logs/deploy.log 2>&1

clean:
	@echo "[ğŸ§¹] Suppression des conteneurs et nettoyage..."
	docker-compose down -v
	@echo "[ğŸ—ï¸] Suppression des clÃ©s SSH..."
	rm -f ~/.ssh/ansible_key ~/.ssh/ansible_key.pub
	@echo "[ğŸ—‘ï¸] Suppression des logs..."
	rm -rf logs